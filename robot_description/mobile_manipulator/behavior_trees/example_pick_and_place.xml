<?xml version="1.0"?>
<root BTCPP_format="4">
  <!-- 
    Example Behavior Tree for Mobile Manipulator with OpenManipulator-X
    This BT demonstrates a simple pick-and-place scenario:
    1. Navigate to pickup location
    2. Move arm to pickup pose
    3. Grasp object
    4. Navigate to place location
    5. Move arm to place pose
    6. Release object
    7. Return home
  -->
  
  <BehaviorTree ID="PickAndPlaceTask">
    <Sequence name="PickAndPlaceSequence">
      
      <!-- Navigate to pickup location -->
      <SubTree ID="NavigateToLocation" target_x="2.0" target_y="2.0" target_yaw="0.0"/>
      
      <!-- Pick up object -->
      <SubTree ID="PickObject"/>
      
      <!-- Navigate to place location -->
      <SubTree ID="NavigateToLocation" target_x="-2.0" target_y="-2.0" target_yaw="1.57"/>
      
      <!-- Place object -->
      <SubTree ID="PlaceObject"/>
      
      <!-- Return to home position -->
      <SubTree ID="NavigateToLocation" target_x="0.0" target_y="0.0" target_yaw="0.0"/>
      
    </Sequence>
  </BehaviorTree>

  <!-- Navigate to a specific location -->
  <BehaviorTree ID="NavigateToLocation">
    <Sequence name="NavigationSequence">
      
      <!-- Compute path to goal -->
      <ComputePathToPose goal="{goal}" path="{path}" planner_id="GridBased"/>
      
      <!-- Follow the path -->
      <Fallback name="FollowPathWithRecovery">
        <FollowPath path="{path}" controller_id="FollowPath"/>
        
        <!-- Recovery behaviors if path following fails -->
        <Sequence name="RecoverySequence">
          <ClearCostmap name="ClearLocalCostmap" service_name="local_costmap/clear_entirely_local_costmap"/>
          <ClearCostmap name="ClearGlobalCostmap" service_name="global_costmap/clear_entirely_global_costmap"/>
          <Spin spin_dist="1.57"/>
          <Wait wait_duration="2"/>
        </Sequence>
      </Fallback>
      
    </Sequence>
  </BehaviorTree>

  <!-- Pick object subtree -->
  <BehaviorTree ID="PickObject">
    <Sequence name="PickSequence">
      
      <!-- Move arm to pre-grasp position (home position) -->
      <Action ID="MoveArm" 
              joint_positions="0.0;0.0;0.0;0.0"
              joint_names="joint1;joint2;joint3;joint4"/>
      
      <!-- Wait for arm to stabilize -->
      <Wait wait_duration="1"/>
      
      <!-- Move to grasp position (reach forward and down) -->
      <Action ID="MoveArm" 
              joint_positions="0.0;-0.5;0.8;-0.3"
              joint_names="joint1;joint2;joint3;joint4"/>
      
      <!-- Open gripper -->
      <Action ID="MoveGripper" 
              joint_positions="0.019;-0.019"
              joint_names="gripper_left_joint;gripper_right_joint"/>
      
      <!-- Wait for gripper to open -->
      <Wait wait_duration="0.5"/>
      
      <!-- Close gripper to grasp -->
      <Action ID="MoveGripper" 
              joint_positions="-0.005;0.005"
              joint_names="gripper_left_joint;gripper_right_joint"/>
      
      <!-- Wait for grasp -->
      <Wait wait_duration="0.5"/>
      
      <!-- Lift object -->
      <Action ID="MoveArm" 
              joint_positions="0.0;-0.3;0.5;-0.2"
              joint_names="joint1;joint2;joint3;joint4"/>
      
    </Sequence>
  </BehaviorTree>

  <!-- Place object subtree -->
  <BehaviorTree ID="PlaceObject">
    <Sequence name="PlaceSequence">
      
      <!-- Move arm to pre-place position -->
      <Action ID="MoveArm" 
              joint_positions="0.0;-0.3;0.5;-0.2"
              joint_names="joint1;joint2;joint3;joint4"/>
      
      <!-- Wait for arm to stabilize -->
      <Wait wait_duration="1"/>
      
      <!-- Move to place position -->
      <Action ID="MoveArm" 
              joint_positions="0.0;-0.5;0.8;-0.3"
              joint_names="joint1;joint2;joint3;joint4"/>
      
      <!-- Open gripper to release -->
      <Action ID="MoveGripper" 
              joint_positions="0.019;-0.019"
              joint_names="gripper_left_joint;gripper_right_joint"/>
      
      <!-- Wait for release -->
      <Wait wait_duration="0.5"/>
      
      <!-- Retract arm to safe position -->
      <Action ID="MoveArm" 
              joint_positions="0.0;0.0;0.0;0.0"
              joint_names="joint1;joint2;joint3;joint4"/>
      
    </Sequence>
  </BehaviorTree>

</root>
